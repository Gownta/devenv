#!/usr/bin/python3

"""
fixmydev

Run a series of health checks and remediations on the current server.

Standalone file that can also be used to set up a new server.
"""


import argparse
import getpass
import os
import shlex
import shutil
import subprocess
import sys


################################################################################
### Args
################################################################################


def get_parser():
    parser = argparse.ArgumentParser(
        prog="fixmydev",
        description="Fix my devserver",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument(
        "--no-color",
        action="store_true",
        help="Disable color in the output",
    )

    parser.add_argument(
        "-i",
        "--interactive",
        action="store_true",
        help="Prompt before running commands",
    )

    return parser


def init_args(argv):
    parser = get_parser()
    global args
    args = parser.parse_args(argv)


################################################################################
### Interaction
################################################################################


def query(msg, valid=None):
    if valid is None:
        valid = ["", "y", "n"]
    while True:
        ans = input(msg)[:1].lower()
        if ans in valid:
            return ans


def color(msg, clr):
    if args.no_color:
        return msg
    return f"\033[38;5;{clr}m{msg}\033[0m"


def run(cmd, check=True, **kwargs):
    if args.interactive:
        pre = "Run command '"
        post = "'? [Y/n] "
    else:
        pre = "Running command '"
        post = "'"
    pre = color(pre, 223)
    post = color(post, 223)
    mid = color(' '.join(shlex.quote(c) for c in cmd), 220)
    whole = pre + mid + post

    if args.interactive:
        ans = query(whole)
        if ans not in ["", "y"]:
            return None
    else:
        print(whole, flush=True)

    return subprocess.run(cmd, check=check, **kwargs)


################################################################################
### Fixups
################################################################################


def install_packages(packages):
    print(color("Fetching packages...", 32))
    run(["sudo", "dnf", "install", "-y"] + packages)
    run(["sudo", "dnf", "upgrade"])


def shell_to_zsh(user):
    print(color("Using zsh...", 32))

    passwd = subprocess.run(["getent", "passwd", user], capture_output=True, text=True, check=True).stdout.strip()
    shell = passwd.split(":")[-1]

    if os.path.basename(shell) != "zsh":
        zsh = subprocess.check_output(["which", "zsh"], text=True).strip()
        print(f"Shell is {shell}; switching to zsh ({zsh})")
        run(["sudo", "usermod", "--shell", zsh, user])


def setup_ssh():
    print(color("Configuring ssh...", 32))

    os.makedirs(".ssh", mode=0o700, exist_ok=True)

    auth_keys = ".ssh/authorized_keys"
    print(color(f"Checking {auth_keys}...", 32))
    if not os.path.exists(auth_keys):
        if subprocess.run(["id", "ec2-user"], capture_output=True).returncode == 0:
            fn = "/home/ec2-user/.ssh/authorized_keys"
            res = subprocess.run(["sudo", "cat", fn], capture_output=True, text=True)
            if res.returncode != 0:
                print(color("failed to open {fn}", 196))
            else:
                print("copying authorized_keys from ec2-user")
                content = res.stdout
                with open(auth_keys, "x") as f:
                    f.write(content)
                os.chmod(auth_keys, 0o600)

    print(color("Checking id_ed25519...", 32))
    pub = ".ssh/id_ed25519.pub"
    if not os.path.exists(pub):
        run(["ssh-keygen", "-t", "ed25519", "-C", "nicholas.ormrod@gmail.com"])
        with open(pub) as f:
            content = f.read()
        print(f"Add the following key to github at https://github.com/settings/keys:\n\n  {content}\n")
        input("press any key to continue")


def ssh_agent():
    print("Running 'eval $(ssh-agent -s)'")
    os.system("eval $(ssh-agent -s)")
    
    run(["ssh-add", ".ssh/id_ed25519"])


def my_github(my_repos):
    os.makedirs("dev", exist_ok=True)

    for repo in my_repos:
        print(color(f"Cloning {repo}...", 32))
        dst = f"dev/{repo}"
        if not os.path.exists(dst):
            run(["git", "clone", f"git@github.com:Gownta/{repo}.git", dst])


def dotfiles():
    rms = [".bashrc", ".bash_profile", ".bash_logout", ".zprofile"]
    syms = {
        "gitconfig": ".gitconfig",
        "textmate_properties": ".tm_properties",
        "tmux.conf": ".tmux.conf",
        "vimrc": ".vimrc",
        "shell/env": ".zshenv",
        "shell/profile.zsh": ".zshrc",
    }
    assert os.path.exists("dev/devenv"), "need to clone devenv first"
    orig = "dev/devenv/originals"
    os.makedirs(orig, exist_ok=True)

    for rm in rms:
        if os.path.exists(rm):
            dn = rm[1:] if rm.startswith(".") else rm
            dst = os.path.join(orig, dn)
            print(color(f"Saving {rm} to {dst}...", 32))
            shutil.move(rm, dst)

    for real, sym in syms.items():
        real = os.path.join("dev/devenv/configs", real)
        if not os.path.exists(sym):
            print(color(f"Symlinking {sym} -> {real}...", 32))
            os.symlink(real, sym)
        elif os.path.islink(sym) and os.readlink(sym) == real:
            pass
        else:
            print(color(f"Dotfile {sym} already exists", 160))

    print(color("On my local mbp, symlink .zlogin for the ssh portal", 10))


################################################################################
### Main
################################################################################


if __name__ == "__main__":
    init_args(sys.argv[1:])

    # Ensure this is run as user, and not as root, from the homedir
    cur_user = getpass.getuser()
    assert cur_user != "root", "fixmydev should be run as a sudo-priviledged user"
    os.chdir(os.path.expanduser("~"))

    # Packages
    install_packages(["git", "zsh", "tmux", "htop"])

    # ssh
    setup_ssh()
    ssh_agent()

    # Github repos
    my_github(["devenv", "starlang", "values", "hanabi"])

    # Dotfiles
    dotfiles()

    # Shell to zsh
    shell_to_zsh(cur_user)
