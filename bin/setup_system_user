#!/usr/bin/python3


import argparse
import os
import shlex
import shutil
import subprocess
import sys


def get_args(argv):
    parser = argparse.ArgumentParser(
        prog="setup_system_user",
        description="Setup a system user, with sudoer power",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument(
        "unixname",
        help="The unixname of the user to add",
    )

    args = parser.parse_args(argv)

    return args


def cmd(cmd, check=True, **kwargs):
    print(" ".join(shlex.quote(c) for c in cmd))
    return subprocess.run(cmd, check=check, **kwargs)


if __name__ == "__main__":
    # Parse args
    args = get_args(sys.argv[1:])
    unixname = args.unixname

    # Create the user
    exists = subprocess.run(["id", unixname], capture_output=True).returncode == 0
    assert not exists
    cmd(["sudo", "adduser", unixname])

    # Grant sudoer power
    sudoers = "/etc/sudoers"
    with open(sudoers) as f:
        content = f.read()
    content = content + f"""
## Grant {unixname} full sudoer power
{unixname}\tALL=(ALL)\tNOPASSWD: ALL
"""
    tmp = sudoers + ".tmp"
    try:
        with open(tmp, "w") as f:
            f.write(content)
        subprocess.check_call(["sudo", "visudo", "-c", "-f", tmp])
        shutil.move(tmp, sudoers)
    finally:
        try:
            os.remove(tmp)
        except:
            pass
